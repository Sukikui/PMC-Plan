name: PR Validation

on:
  push:
    branches:
      - 'add-place/**'
      - 'add-portal/**'

jobs:
  validate_pr_files:
    runs-on: ubuntu-latest
    name: Validate Files in PR
    steps:
      - name: 📂 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Ensure PRs (incl. forks) check the contributor's HEAD commit
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🔄 Determine changed files
        id: cf
        uses: tj-actions/changed-files@v44
        with:
          files_yaml: |
            json:
              - public/data/places/**/*.json
              - public/data/portals/**/*.json
            images:
              - public/data/place_images/**/*.png
              - public/data/place_images/**/*.jpg
              - public/data/place_images/**/*.jpeg
              - public/data/place_images/**/*.gif

      - name: ✅ Validate changed JSON files
        if: ${{ steps.cf.outputs.json_any_changed == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          for file in ${{ steps.cf.outputs.json_all_changed_files }}; do
            echo "Validating JSON: $file"
            node .github/scripts/validate-data.js "$file"
          done

      - name: 🖼️ Validate changed image files
        if: ${{ steps.cf.outputs.images_any_changed == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          for file in ${{ steps.cf.outputs.images_all_changed_files }}; do
            echo "Validating image: $file"
            node .github/scripts/validate-images.js "$file"
          done