name: Validate Community Contributions

on:
  pull_request:
    paths:
      - 'public/data/places/*.json'
      - 'public/data/portals/*.json'
  issues:
    types: [opened, edited]

jobs:
  validate-pr-files:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: Validate JSON Files in PR
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install ajv
          
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            public/data/places/*.json
            public/data/portals/*.json
            
      - name: Validate Changed Files
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            node .github/scripts/validate-data.js "$file"
          done

  validate-issue:
    if: github.event_name == 'issues' && (contains(github.event.issue.labels.*.name, 'place') || contains(github.event.issue.labels.*.name, 'portal'))
    runs-on: ubuntu-latest
    name: Validate Issue Template Data and Create PR
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install ajv node-fetch@2
          
      - name: Extract and validate JSON from issue
        uses: actions/github-script@v7
        with:
          script: |
            const { validateIssueData } = require('./.github/scripts/validate-issue.js');
            await validateIssueData(github, context);