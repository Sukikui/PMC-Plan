name: Validate Community Contributions

on:
  pull_request:
    paths:
      - 'public/data/places/*.json'
      - 'public/data/portals/*.json'
  issues:
    types: [opened]

jobs:
  validate-pr-files:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: Validate JSON Files in PR
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install -g ajv-cli
          
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            public/data/places/*.json
            public/data/portals/*.json
            
      - name: Make scripts executable
        run: |
          chmod +x .github/scripts/validate-places.sh
          chmod +x .github/scripts/validate-portals.sh
          
      - name: Filter changed files by type
        id: filter-files
        run: |
          PLACE_FILES=""
          PORTAL_FILES=""
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ $file == public/data/places/*.json ]]; then
              PLACE_FILES="$PLACE_FILES $file"
            elif [[ $file == public/data/portals/*.json ]]; then
              PORTAL_FILES="$PORTAL_FILES $file"
            fi
          done
          
          echo "place_files=$PLACE_FILES" >> $GITHUB_OUTPUT
          echo "portal_files=$PORTAL_FILES" >> $GITHUB_OUTPUT
          
      - name: Validate Places
        if: steps.filter-files.outputs.place_files != ''
        run: |
          .github/scripts/validate-places.sh "${{ steps.filter-files.outputs.place_files }}"
          
      - name: Validate Portals
        if: steps.filter-files.outputs.portal_files != ''
        run: |
          .github/scripts/validate-portals.sh "${{ steps.filter-files.outputs.portal_files }}"

  validate-issue:
    if: github.event_name == 'issues' && (contains(github.event.issue.labels.*.name, 'place') || contains(github.event.issue.labels.*.name, 'portal'))
    runs-on: ubuntu-latest
    name: Validate Issue Template Data and Create PR
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install -g ajv-cli
          
      - name: Extract and validate JSON from issue
        uses: actions/github-script@v7
        with:
          script: |
            const { validateIssueData } = require('./.github/scripts/validate-issue.js');
            await validateIssueData(github, context);